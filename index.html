<!DOCTYPE html>
<html >

<head>
  <meta charset="UTF-8">
  <title>Crash d'avions 1.0</title>
</head>

<select id="selectX"></select>
<select id="selectY"></select>
<select id="selectCompagnie"></select>

<body>

<style>

.legende {
  font: 10px sans-serif; }

body {
  font: 12px sans-serif,}

svg{
  border: solid 1px;
}

path { 
  stroke: #4682B4;
  stroke-width: 2;
  fill: none;
}

.axis path,
.axis line {
    fill: none;
    stroke: grey;
    stroke-width: 1;
    shape-rendering: crispEdges;
}

div.tooltip { 
    position: absolute;     
    text-align: center;     
    /*width: 80px;          
    height: 40px;*/        
    padding: 2px;       
    font: 12px helvetica;    
    /*background: #ffcc99;*/
    border: 0px;    
    border-radius: 8px;     
    pointer-events: none;     
}

</style>

  
  <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/4.5.0/d3.min.js'></script>
  <script>
  	d3.csv("crash.csv",function(d){
  		return{
  			kmSemaine : +d.avail_seat_km_per_week,
  			accidents85 : +d.incidents_85_99,
  			accidentsMortels85 : +d.fatal_accidents_85_99,
  			morts85 : +d.fatalities_85_99,
  			accidents00: +d.incidents_00_14,
  			accidentsMortels00 : +d.fatal_accidents_00_14,
  			morts00 : +d.fatalities_00_14,
  			compagnie : d.airline,
  			continent : d.continent
  		};
  }, function(data){
      let marge = 30;
      let largeur = (window.innerWidth - (2 * marge))/2;
      let hauteur = (window.innerHeight - (2 * marge))/2;
      //Initialisation des deux variables avec déjà une certaine valeur
      let variableX = "kmSemaine";
      let variableY = "accidents";
      let compagnieChoisie = "Air France";
      let optionsCompagnie = [];
      let optionsAxes = ["kmSemaine","accidents","accidentsMortels","morts"];



      //Unification de la période, on va maintenant de 85 à 2014 et basta
      for (var i = 0; i <= 55; i++) {
        data[i].accidents = data[i].accidents85+data[i].accidents00,
        data[i].accidentsMortels = data[i].accidentsMortels85+data[i].accidentsMortels00,
        data[i].morts = data[i].morts85+data[i].morts00,
        optionsCompagnie[i] = data[i].compagnie;
      }


      optionsAxes.forEach(function(d){
        d3.select("#selectX")
          .append("option")
          .attr("value",d)
          .text(d);
      })

      optionsAxes.forEach(function(d){
        d3.select("#selectY")
          .append("option")
          .attr("value",d)
          .text(d);
      })

      optionsCompagnie.forEach(function(d){
        d3.select("#selectCompagnie")
          .append("option")
          .attr("value",d)
          .text(d);
      })

      //Quand on choisit une valeur, on retient la valeur choisie et on lance la fonction graphe avec
      //cette nouvelle valeur
      function choixX(){
        let variableX = d3.select(this).property('value')
        let variableY = d3.select("#selectY").property('value')
        graphe(variableX,variableY)
      }

      function choixY(){
        let variableX = d3.select("#selectX").property('value')
        let variableY = d3.select(this).property('value')
        graphe(variableX,variableY)

      }

      function choixCompagnie(){
        let compagnieChoisie = d3.select(this).property('value')
        console.log(compagnieChoisie)
      }

      d3.select("#selectX")
        .on("change",choixX)

      d3.select("#selectY")
        .on("change",choixY)

      d3.select("#selectCompagnie")
        .on("change",choixCompagnie)

  		let canevas = d3.select("body")
  			.append("svg")
  			 .attr("height", hauteur + 2*marge)
  			 .attr("width",largeur + 2*marge)
         .append("g")
         .attr("transform", "translate(" + marge + "," + marge + ")");

      let canevas2 = d3.select("body")
        .append("svg")
         .attr("height", hauteur + 2*marge)
         .attr("width",largeur + 2*marge)
         .append("g")
         .attr("transform", "translate(" + marge + "," + marge + ")");

      let div = d3.select("body").append("div") 
        .attr("class", "tooltip")       
        .style("opacity", 0);



/*Fonction qui prend un argument à mettre en X, un argument en Y
et qui crée une visualisation en fonction de ces deux argumetns*/

     function graphe(abs,ord){

        var echelleX = d3.scaleLinear()
          .domain([0,d3.max(data,d=>d[abs])])
          .range([marge,largeur-marge]);

        var echelleY = d3.scaleLinear()
          .domain([0,d3.max(data,d=>d[ord])])
          .range([hauteur-marge,marge]);

        var echelleCouleur = d3.scaleOrdinal()
          .domain(["Europe","South America","North America","Asia",
             "Australia","Africa"])
          .range([0,1/5,2/5,3/5,4/5,1]);

        var cercles = canevas.selectAll("circle").data(data);
        //Au début, tous les cercles sont invisibles en bas à gauche
          cercles.enter()
          .append("circle")
            .attr("cx",d=>echelleX(0))
            .attr("cy",d=>echelleY(0))
            .attr("r",4)
            .attr("opacity",0)

          cercles.transition()
            .duration(500)
            .attr("cx",d=>echelleX(d[abs]))
            .attr("cy",d=>echelleY(d[ord]))
            .attr("r",4)
            .attr("opacity",.9)
            .attr("fill",d=>d3.interpolateCool(echelleCouleur(d.continent)))

          cercles.exit()
            .remove()

          cercles.on("mouseover",function(d){
            d3.select(this)
              .attr("r",6)
            div.transition()
              .duration(200)
              .style("opacity",.9)
            div.html("<b>Airline : </b>"+d.compagnie+"<br><b>Continent : </b>"+d.continent)
              .style("left", (d3.event.pageX) + "px")   
              .style("top", (d3.event.pageY - 28) + "px");
        })
          .on("mouseout",function(d){
            d3.select(this)
              .attr("r",4)
            div.transition()
              .duration(200)
              .style("opacity",0);
        })

//Création des deux axes
      var axeX = d3.axisBottom(echelleX);
      var axeY = d3.axisLeft(echelleY);

//Axe X avec la légende
      canevas.append("g")
        .attr("transform",`translate(0,${hauteur-marge})`)
        .call(axeX.ticks(6,"s"));

      canevas.append("text")
        .attr("class","legende")
        .attr("transform", "translate(" + (largeur / 2) + " ," + (hauteur + marge/2) + ")")
        .style("text-anchor","middle")
        .text(abs);

//Axe Y avec sa légende
      canevas.append("g")
        .attr("transform",`translate(${marge},0)`)
        .call(axeY.ticks(6,"s"));

      canevas.append("text")
        .attr("class","legende")
        .attr("transform","rotate(-90)")
        .attr("y", 0)
        .attr("x",-hauteur/2)
        .style("text-anchor","middle")
        .text(ord);

      }


      graphe("kmSemaine","kmSemaine");


      /*canevas.append("text")
        .attr("x", (largeur / 2))             
        .attr("y", hauteur / 2)
        .attr("text-anchor", "middle")  
        .style("font-size","12px")
        .style("text-decoration", "underline")  
        .text("Graphique");*/

  });

  </script>

  
</body>
</html>
