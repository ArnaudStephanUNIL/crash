<!DOCTYPE html>
<html >

<head>
  <meta charset="UTF-8">
  <title>Crash d'avions 1.0</title>
</head>

<select id="selectX"></select>
<select id="selectY"></select>
<select id="selectCompagnie"></select>

<body>

<style>

.titre {
  font: 10px sans-serif; }

.axeVerticalLegende {
  font: 10px sans-serif; }

.axeHorizontalLegende {
  font: 10px sans-serif; }

body {
  font: 12px sans-serif,}

svg{
  border: solid 1px;
}

path { 
  stroke: #4682B4;
  stroke-width: 2;
  fill: none;
}

.axis path,
.axis line {
    fill: none;
    stroke: grey;
    stroke-width: 1;
    shape-rendering: crispEdges;
}

div.tooltip { 
    position: absolute;     
    text-align: center;            
    padding: 2px;       
    font: 12px sans-serif;    
    background: #ffffff;
    border-radius: 4px;     
    pointer-events: none;     
}

</style>

  
  <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/4.5.0/d3.min.js'></script>
  <script>
  	d3.csv("crash.csv",function(d){
  		return{
  			kmSemaine : +d.avail_seat_km_per_week,
  			accidents85 : +d.incidents_85_99,
  			accidentsMortels85 : +d.fatal_accidents_85_99,
  			morts85 : +d.fatalities_85_99,
  			accidents00: +d.incidents_00_14,
  			accidentsMortels00 : +d.fatal_accidents_00_14,
  			morts00 : +d.fatalities_00_14,
  			compagnie : d.airline,
  			continent : d.continent
  		};
  }, function(data){
      let marge = 30;
      let largeur = (window.innerWidth - (2 * marge))/2;
      let hauteur = (window.innerHeight - (2 * marge))/2;
      //Initialisation des variables avec déjà une certaine valeur
      let variableX = "kmSemaine";
      let variableY = "accidents";
      let compagnieChoisie = "$Air France";
      let optionsCompagnie = [];
      let optionsAxes = ["kmSemaine","accidents","accidentsMortels","morts"];

      //On réorganise les données grâce à d3.nest (cf. Mister Nester pour comprendre)
      let nestCompagnies = d3.nest()
      .key(d=>d.compagnie)
      .map(data);

      //Addition des deux périodes
      for (var i = 0; i <= 55; i++) {
        data[i].accidents = data[i].accidents85+data[i].accidents00,
        data[i].accidentsMortels = data[i].accidentsMortels85+data[i].accidentsMortels00,
        data[i].morts = data[i].morts85+data[i].morts00,
        optionsCompagnie[i] = data[i].compagnie;
      }


      optionsAxes.forEach(function(d){
        d3.select("#selectX")
          .append("option")
          .attr("value",d)
          .text(d);
      })

      optionsAxes.forEach(function(d){
        d3.select("#selectY")
          .append("option")
          .attr("value",d)
          .text(d);
      })

      optionsCompagnie.forEach(function(d){
        d3.select("#selectCompagnie")
          .append("option")
          .attr("value",d)
          .text(d);
      })

      //Quand on choisit une valeur, on retient la valeur choisie et on lance la fonction graphe avec
      //cette nouvelle valeur
      function choixX(){
        var variableX = d3.select(this).property('value')
        var variableY = d3.select("#selectY").property('value')
        graphe(variableX,variableY)
      }

      function choixY(){
        var variableX = d3.select("#selectX").property('value')
        var variableY = d3.select(this).property('value')
        graphe(variableX,variableY)
      }

      function choixCompagnie(){
        var compagnieChoisie = "$"+d3.select(this).property('value')
        console.log(compagnieChoisie);
        console.log(nestCompagnies[compagnieChoisie][0]["kmSemaine"])
        graphe2(compagnieChoisie);
      }

      d3.select("#selectX")
        .on("change",choixX)

      d3.select("#selectY")
        .on("change",choixY)

      d3.select("#selectCompagnie")
        .on("change",choixCompagnie)

  		let canevas = d3.select("body")
  			.append("svg")
  			 .attr("height", hauteur + 2*marge)
  			 .attr("width",largeur + 2*marge)
         .append("g")
         .attr("transform", "translate(" + marge + "," + marge + ")");

      let canevas2 = d3.select("body")
        .append("svg")
         .attr("height", hauteur + 2*marge)
         .attr("width",largeur + 2*marge)
         .append("g")
         .attr("transform", "translate(" + marge + "," + marge + ")");

      let div = d3.select("body").append("div") 
        .attr("class", "tooltip")       
        .style("opacity", 0);



/*Fonction qui prend un argument à mettre en X, un argument en Y
et qui crée une visualisation en fonction de ces deux argumetns*/

     function graphe(abs,ord){

        var echelleX = d3.scaleLinear()
          .domain([0,d3.max(data,d=>d[abs])])
          .range([marge,largeur-marge]);

        var echelleY = d3.scaleLinear()
          .domain([0,d3.max(data,d=>d[ord])])
          .range([hauteur-marge,marge]);

        var echelleCouleur = d3.scaleOrdinal()
          .domain(["Europe","South America","North America","Asia",
             "Australia","Africa"])
          .range([0,1/5,2/5,3/5,4/5,1]);

        var cercles = canevas.selectAll("circle").data(data);
        //Au début, tous les cercles sont invisibles en bas à gauche
          cercles.enter()
          .append("circle")
            .attr("cx",d=>echelleX(0))
            .attr("cy",d=>echelleY(0))
            .attr("r",0)
            .attr("opacity",0)

          cercles.transition()
            .duration(500)
            .attr("cx",d=>echelleX(d[abs]))
            .attr("cy",d=>echelleY(d[ord]))
            .attr("r",4)
            .attr("opacity",.9)
            .attr("fill",d=>d3.interpolateCool(echelleCouleur(d.continent)))

          cercles.exit()
            .remove()

          cercles.on("mouseover",function(d){
            d3.select(this)
              .attr("r",6)
            div.transition()
              .duration(200)
              .style("opacity",.9)
            div.html("<b>Airline : </b>"+d.compagnie+"<br><b>Continent : </b>"+d.continent)
              .style("left", (d3.event.pageX) + "px")   
              .style("top", (d3.event.pageY - 28) + "px");
        })
          .on("mouseout",function(d){
            d3.select(this)
              .attr("r",4)
            div.transition()
              .duration(200)
              .style("opacity",0);
        })

//Création des deux axes

      var axeX = d3.axisBottom(echelleX);
      var axeY = d3.axisLeft(echelleY);

//Axe X avec la légende
      canevas.append("g")
        .attr("transform",`translate(0,${hauteur-marge})`)
        .attr("class","axeHorizontal")
        .call(axeX.tickFormat(d3.format(",.0s")));

      canevas.append("text")
        .attr("class","axeHorizontalLegende")
        .attr("transform", "translate(" + (largeur / 2) + " ," + (hauteur + marge/2) + ")")
        .style("text-anchor","middle")
        .text(abs);

//Axe Y avec sa légende
      canevas.append("g")
        .attr("transform",`translate(${marge},0)`)
        .attr("class","axeVertical")
        .call(axeY.tickFormat(d3.format(",.0s")));

      canevas.append("text")
        .attr("class","axeVerticalLegende")
        .attr("transform","rotate(-90)")
        .attr("y", 0)
        .attr("x",-hauteur/2)
        .style("text-anchor","middle")
        .text(ord);

//Titre du graphique
      canevas.append("text")
        .attr("class","titre")
        .attr("x", (largeur/2))             
        .attr("y", marge/2)
        .attr("text-anchor", "middle")    
        .text(ord+" en fonction de "+abs);

    
//Rafraîchissement des axes, des légendes et du titre
      canevas.selectAll(".axeHorizontal")
        .call(axeX
          .ticks(4)
          .tickFormat(d3.format(",.00s")));

      canevas.selectAll(".axeHorizontalLegende")
        .text(abs);

      canevas.selectAll(".axeVertical")
        .call(axeY
          .ticks(4)
          .tickFormat(d3.format(",.00s")));

      canevas.selectAll(".axeVerticalLegende")
        .text(ord);

      canevas.selectAll(".titre")
        .text(ord+" en fonction de "+abs);
      
      }

      function graphe2(funcComp){

        var echelleX = d3.scaleLinear()
          .domain([0,d3.max(data,d=>d.accidents)])
          .range([marge,largeur-marge]);

        var gap = 10;
        var hauteurRect = hauteur/10;

        var accidentsMoyens = d3.mean(data,d=>d.accidents);
        var accidentsMortelsMoyens = d3.mean(data,d=>d.accidentsMortels);

        //Création des deux barres de référence
        var rectAccidentsMoyens = canevas2.append("rect")
          //.attr("class","immobile")
          .attr("opacity",0.5)
          .attr("x",marge)
          .attr("y",marge)
          .attr("width",echelleX(accidentsMoyens))
          .attr("height",hauteurRect)
          .attr("fill","#b3e6ff")
          .on("mouseover",function(d){
            d3.select(this)
            .attr("opacity",0.9)
            div.transition()
              .duration(200)
              .style("opacity",.9)
            div.html("<b>Accidents moyens : </b>"+Math.round(accidentsMoyens))
              .style("left", (d3.event.pageX) + "px")   
              .style("top", (d3.event.pageY - 28) + "px");
        })
          .on("mouseout",function(d){
            d3.select(this)
            .attr("opacity",0.5)
            div.transition()
              .duration(200)
              .style("opacity",0);
        });

        var rectangles = canevas2.selectAll("rect").data(data);

//nestCompagnies[compagnieChoisie][0]["kmSemaine"]
          rectangles.enter()
            .append("rect")
            //Les rectangles qui arrivent sont invisibles
            .attr("opacity",0.5)
            .attr("x",marge)
            .attr("y",marge+hauteurRect+gap)
            .attr("width",0)//echelleX(nestCompagnies[funcComp][0]["accidents"]))
            .attr("height",hauteurRect)
            .attr("fill","#b3e6ff");

          rectangles.transition()
            .duration(500)
            .attr("opacity",0.5)
            .attr("x",marge)
            .attr("y",marge+hauteurRect+gap)
            .attr("width",echelleX(nestCompagnies[funcComp][0]["accidents"]))
            .attr("height",hauteurRect)
            .attr("fill","#b3e6ff");

        var rectAccidentsMortelsMoyens = canevas2.append("rect")
          //.attr("class","immobile")
          .attr("opacity",0.5)
          .attr("x",marge)
          .attr("y",marge+2*(hauteurRect+gap))
          .attr("width",echelleX(accidentsMortelsMoyens))
          .attr("height",hauteurRect)
          .attr("fill","#ffad99")
          .on("mouseover",function(d){
            d3.select(this)
            .attr("opacity",0.9)
            div.transition()
              .duration(200)
              .style("opacity",.9)
            div.html("<b>Accidents mortels moyens : </b>"+Math.round(accidentsMortelsMoyens))
              .style("left", (d3.event.pageX) + "px")   
              .style("top", (d3.event.pageY - 28) + "px");
        })
          .on("mouseout",function(d){
            d3.select(this)
            .attr("opacity",0.5)
            div.transition()
              .duration(200)
              .style("opacity",0);
        });


          /*rectangles.enter()
            .append("rect")
            .attr("x")
            .attr("y")
            .attr()*/
      }

  graphe("kmSemaine","kmSemaine");
  graphe2(compagnieChoisie);
  //graphe2();


  });

  </script>

  
</body>
</html>
